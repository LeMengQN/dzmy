import{aG as e,bE as t,aD as i,bF as s,bG as a,a0 as l,ad as o,af as n,f as d,g as c,w as r,i as h,k as u,j as p,l as m,m as b,n as f,bt as g,z as w,x as C,D as x,y,aE as v,S as _,bu as S}from"./index.1a866322.js";import{_ as M}from"./u-button.9dd62910.js";import{r as T}from"./uni-app.es.5638d019.js";import{_ as U}from"./u-field.6c7fbccd.js";import{_ as P}from"./u-popup.ac74065a.js";import{_ as k}from"./u-modal.f80ad17e.js";import"./index.0e6263ad.js";import{b as F,P as V}from"./pdfh5.0d53b043.js";import{_ as j}from"./plugin-vue_export-helper.21dcd24c.js";import"./u-icon.1541541b.js";let D;var I=j({data:()=>({current:0,resultUrl:"",dom:null,line:[],width:"0px",height:"0px",radius:0,base64data:"",qianSuccess:!1,title:"签署成功",content:"对方电子合同已同步,并已通过短信方式告知对方。",pdfh5:null,UserContract:!1,ContractStatus:!1,fileUrl:!1,isMobile:!0,phoneCode:"",btnDisabled:!1,dialogVisible:!1,btnTimer:60,Contract:"",Id:0,SecondMobile:"",FileUrl:"",value:null,movesStu:!0,codeDisabled:!0,imgTempFilePath:""}),created(){e({success:e=>{this.width=e.windowWidth,this.height=e.windowHeight}}),this.dom=t("designature",this)},onLoad(e){let t=decodeURIComponent(atob(decodeURIComponent(e.Contract))),i=t.split("|")[0];this.Contract=t,this.Id=i,this.SecondMobile=t.split("|")[1],console.log("电子合同==>",i),this.getContract(i)},methods:{cancel(){this.current=0},end(e){},distance(e,t){let i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)},starts(e){console.log(e),this.line.push({points:[{time:(new Date).getTime(),x:e.touches[0].x,y:e.touches[0].y,dis:0}]});let t={x:e.touches[0].x,y:e.touches[0].y};this.currentPoint=t,this.drawer(this.line[this.line.length-1]),this.movesStu=!1},moves(e){let t={x:e.touches[0].x,y:e.touches[0].y};this.lastPoint=this.currentPoint,this.currentPoint=t,this.line[this.line.length-1].points.push({time:(new Date).getTime(),x:e.touches[0].x,y:e.touches[0].y,dis:this.distance(this.currentPoint,this.lastPoint)}),this.drawer(this.line[this.line.length-1])},drawer(e){let t,i,s,a,l,o,n,d,c=.5;var r=0;if(e.points.length>2){let p=e.points[e.points.length-3],m=e.points[e.points.length-2],b=e.points[e.points.length-1];n=m.x,d=m.y,t=p.x,s=p.y,i=b.x,a=b.y;var h;r=m.time-p.time+(b.time-m.time),h=m.dis+p.dis+b.dis;var u=this.dom;Math.min(r/h*this.linePressure+this.lineMin,this.lineMax),l=(n-Math.pow(.5,2)*t-Math.pow(c,2)*i)/.5,o=(d-Math.pow(.5,2)*s-Math.pow(c,2)*a)/.5,u.setLineCap("round"),u.beginPath(),u.setStrokeStyle("black"),u.setLineWidth(5),u.moveTo(t,s),u.quadraticCurveTo(l,o,i,a),u.stroke(),u.draw(!0)}},clear(){this.dom.clearRect(0,0,1e3,1e3),this.dom.draw(),this.movesStu=!0},save(){var e=this;console.log(555),e.dom.draw(!0,(()=>{i({canvasId:"designature",fileType:"png",width:Math.ceil(this.width),height:Math.ceil(.8*this.height),destWidth:Math.ceil(this.width),destHeight:Math.ceil(.8*this.height),quality:.5,success:function(t){console.log(t.tempFilePath),e.base64data=t.tempFilePath,e.dialogVisible=!0,D=t.tempFilePath,F(t.tempFilePath).then((t=>{console.log(t),e.imgTempFilePath=t})).catch((e=>{console.error(e)}))},fail(e){console.log(e)}},this)}))},getContract(e){s(e).then((e=>{const t=e.Result;if(t&&"object"==typeof t){let e=String.raw`${t.FileUrl}`.replace("D:\\wwwroot\\xzl\\wx\\ims\\wwwroot\\Content\\Upload\\ContractFile\\","https://imswx.xuezhilian.com/Content/Upload/ContractFile/");console.log("文件地址",e),this.FileUrl=t.FXQFileUrl,this.pdfh5=new V("#contractPdf",{renderType:"canvas",scale:1,pdfurl:t.FXQFileUrl}),this.pdfh5.on("complete",(function(e,t,i){console.log("状态："+e+"，信息："+t+"，耗时："+i+"毫秒，总页数："+this.totalNum)})),7==t.Status&&(this.ContractStatus=!0)}})).catch((e=>{}))},SendCode(){a({url:`https://eduwx.xuezhilian.com/xzb/Contract/FXQsend?mobile=${this.SecondMobile}&type=3`,data:{mobile:this.SecondMobile,content:"",type:3},method:"POST",success:e=>{1e4===e.data.code?(l({icon:"none",title:"发送成功"}),this.btnDisabled=!0,this.time(),this.codeDisabled=!1):l({icon:"none",title:"发送失败"})},fail(){l({icon:"none",title:"请求失败"})}})},time(){let e=this;0==this.btnTimer?(this.btnDisabled=!1,this.btnTimer=60):(this.btnDisabled=!0,this.btnTimer--,setTimeout((function(){e.time()}),1e3))},saveAsImg(){let e=this;if(e.phoneCode.length<=0)return void e.$u.toast("请输入验证码！",1500);o({title:"签署中..."});let t=window.btoa(unescape(encodeURIComponent(e.Id+"|xuezhilian")));console.log("用户签署===>",t),a({url:"https://eduwx.xuezhilian.com/xzb/Contract/UserContract",method:"POST",data:{UserSgin:D,iCode:t,SecondMobile:e.SecondMobile,Code:e.phoneCode},success:t=>{console.log("签署===>",t);const i=t.data.Result;i&&"object"==typeof i&&"success"==i.code&&200==t.statusCode?(n(),l({icon:"none",title:"签署成功",success(){e.UserContract=!0,e.ContractStatus=!0,setTimeout((()=>{e.dialogVisible=!1,e.qianSuccess=!0,e.current=0,e.pdfh5=new V("#contractPdf",{renderType:"canvas",scale:1,pdfurl:i.url})}),400)}})):(n(),l({icon:"none",title:t.data.Message}))},fail(){n(),l({icon:"none",title:"请求失败"})}})}}},[["render",function(e,t,i,s,a,l){const o=h,n=T(C("u-button"),M),F=x,V=y,j=v,D=_,I=T(C("u-field"),U),z=T(C("u-popup"),P),q=T(C("u-modal"),k);return d(),c(o,null,{default:r((()=>[u(D,{"indicator-dots":!1,autoplay:!1,circular:"",class:"swiper",current:a.current,"disable-touch":!0},{default:r((()=>[p(" PDF "),u(F,{class:"swiper-item"},{default:r((()=>[u(o,{class:"contract position-relative"},{default:r((()=>[u(o,{class:"w-100"},{default:r((()=>[u(o,{id:"contractPdf"})])),_:1}),u(o,{class:"w-90 contrac-btn"},{default:r((()=>[u(n,{disabled:a.ContractStatus,type:"primary",ripple:!0,onClick:t[0]||(t[0]=e=>a.current=1)},{default:r((()=>[m(b(a.ContractStatus?"已签署":"立即签署"),1)])),_:1},8,["disabled"])])),_:1})])),_:1})])),_:1}),u(F,{class:"swiper-item"},{default:r((()=>[p(" 签名横屏 "),u(o,{class:"signa flex flex-column justify-between position-relative"},{default:r((()=>[u(o,{class:"backToast"},{default:r((()=>[u(V,{class:"tip"},{default:r((()=>[m("请你在此手动签写自己的签章，签写操作完毕点击下一步按钮")])),_:1}),u(o,null,{default:r((()=>[m("请本人签名")])),_:1})])),_:1}),u(j,{class:"canvas","disable-scroll":"true",style:f({height:Math.ceil(.8*a.height)+"px"}),"canvas-id":"designature",onTouchstart:l.starts,onTouchmove:l.moves,onTouchend:l.end},null,8,["style","onTouchstart","onTouchmove","onTouchend"]),u(o,{class:"bottomBox flex align-center justify-around flex-1"},{default:r((()=>[u(n,{class:"btn",style:f(`width: ${Math.ceil(.12*a.height)}px;`),onClick:l.cancel,ripple:!0,shape:"circle"},{default:r((()=>[m("取消")])),_:1},8,["style","onClick"]),u(n,{disabled:a.UserContract,class:"btn",style:f(`width: ${Math.ceil(.12*a.height)}px;`),onClick:l.clear,ripple:!0,shape:"circle"},{default:r((()=>[m("重写 ")])),_:1},8,["disabled","style","onClick"]),u(n,{disabled:a.UserContract||a.movesStu,class:"btn",style:f(`width: ${Math.ceil(.12*a.height)}px;`),ripple:!0,shape:"circle",type:"primary",onClick:l.save},{default:r((()=>[m("下一步")])),_:1},8,["disabled","style","onClick"])])),_:1}),g(w("img",{src:a.base64data,mode:""},null,8,["src"]),[[S,!1]]),p('  <view style="word-break:break-all; padding: 10px;box-sizing: border-box;">{{base64data}}</view> ')])),_:1})])),_:1})])),_:1},8,["current"]),u(z,{modelValue:a.dialogVisible,"onUpdate:modelValue":t[5]||(t[5]=e=>a.dialogVisible=e),mode:"center"},{default:r((()=>[u(o,{class:"pop-up"},{default:r((()=>[u(o,{class:"popup-tit"},{default:r((()=>[m(" 提示 ")])),_:1}),u(I,{disabled:"",required:"",clearable:"",modelValue:a.SecondMobile,"onUpdate:modelValue":t[1]||(t[1]=e=>a.SecondMobile=e),label:"手机号",placeholder:"请填写手机号"},null,8,["modelValue"]),u(I,{required:"",clearable:"",modelValue:a.phoneCode,"onUpdate:modelValue":t[2]||(t[2]=e=>a.phoneCode=e),maxlength:"6",label:"验证码",placeholder:"请填写验证码"},{right:r((()=>[u(n,{disabled:a.btnDisabled,size:"mini",type:"success",onClick:l.SendCode},{default:r((()=>[m(" 发送验证码"+b(a.btnDisabled?a.btnTimer:""),1)])),_:1},8,["disabled","onClick"])])),_:1},8,["modelValue"]),u(o,{class:"pop-menu"},{default:r((()=>[u(n,{onClick:t[3]||(t[3]=e=>a.dialogVisible=!1)},{default:r((()=>[m("取 消")])),_:1}),u(n,{disabled:a.codeDisabled,type:"primary",onClick:t[4]||(t[4]=t=>e.$u.throttle(l.saveAsImg,500))},{default:r((()=>[m("确 定 ")])),_:1},8,["disabled"]),p(' <u-button type="primary" @click="saveAsImg">确 定</u-button> ')])),_:1})])),_:1})])),_:1},8,["modelValue"]),u(q,{modelValue:a.qianSuccess,"onUpdate:modelValue":t[6]||(t[6]=e=>a.qianSuccess=e),content:a.content},null,8,["modelValue","content"])])),_:1})}],["__scopeId","data-v-0a9898ac"]]);export{I as default};
